@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Resources.Localization> L

<MudPaper Class="pa-4 pa-sm-5" Elevation="1" Style="border: 1px solid var(--mud-palette-divider);">
    <MudStack Spacing="4">
        <MudStack Spacing="2">
            <div class="d-flex justify-space-between align-center flex-wrap" style="gap: 12px;">
                    <MudText Typo="Typo.h6" Class="mb-1">@L["FilterBuilder_Title"]</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Tertiary">
                        @if (Conditions.Any())
                        {
                            @L["FilterBuilder_ActiveFilters"].ToString().Replace("{0}", Conditions.Count.ToString())
                        }
                        else
                        {
                            @L["FilterBuilder_NoFiltersDescription"]
                        }
                    </MudText>

                <div class="d-flex align-center flex-wrap" style="gap: 8px;">
                    <MudButton StartIcon="@Icons.Material.Filled.Add"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               Size="Size.Medium"
                               OnClick="AddCondition"
                               Disabled="@(!FilterableProperties.Any())"
                               aria-label="@L["FilterBuilder_AddFilter"]">
                        <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">@L["FilterBuilder_AddFilterShort"]</MudHidden>
                        <MudHidden Breakpoint="Breakpoint.SmAndDown">@L["FilterBuilder_AddFilter"]</MudHidden>
                    </MudButton>

                    @if (Conditions.Any())
                    {
                        <MudButton StartIcon="@Icons.Material.Filled.Clear"
                                   Color="Color.Default"
                                   Variant="Variant.Text"
                                   Size="Size.Medium"
                                   OnClick="ClearAll"
                                   aria-label="@L["FilterBuilder_ClearAll"]">
                            <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">@L["FilterBuilder_ClearAllShort"]</MudHidden>
                            <MudHidden Breakpoint="Breakpoint.SmAndDown">@L["FilterBuilder_ClearAll"]</MudHidden>
                        </MudButton>
                    }
                </div>
            </div>

            @if (Conditions.Count > 1)
            {
                <MudPaper Class="pa-3" Outlined="true" Style="background-color: var(--mud-palette-background-grey);">
                    <div class="d-flex align-center justify-space-between flex-wrap" style="gap: 12px;">
                        <MudText Typo="Typo.body2" Color="Color.Tertiary">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @L["FilterBuilder_LogicalOperatorDescription"]
                        </MudText>

                        <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small" aria-label="@L["FilterBuilder_LogicalOperatorLabel"]">
                            <MudButton OnClick="@(() => OnLogicalOperatorChanged(false))"
                                       Color="@(!IsOrOperator ? Color.Primary : Color.Default)"
                                       Variant="@(!IsOrOperator ? Variant.Filled : Variant.Outlined)"
                                       StartIcon="@Icons.Material.Filled.FilterList"
                                       aria-pressed="@(!IsOrOperator)"
                                       aria-label="@L["FilterBuilder_LogicalAndTooltip"]">
                                @L["FilterBuilder_LogicalAnd"]
                            </MudButton>
                            <MudButton OnClick="@(() => OnLogicalOperatorChanged(true))"
                                       Color="@(IsOrOperator ? Color.Secondary : Color.Default)"
                                       Variant="@(IsOrOperator ? Variant.Filled : Variant.Outlined)"
                                       StartIcon="@Icons.Material.Filled.AltRoute"
                                       aria-pressed="@IsOrOperator"
                                       aria-label="@L["FilterBuilder_LogicalOrTooltip"]">
                                @L["FilterBuilder_LogicalOr"]
                            </MudButton>
                        </MudButtonGroup>
                    </div>
                </MudPaper>
            }
        </MudStack>

        @if (Conditions.Any())
        {
            <MudStack Spacing="3">
                @for (var i = 0; i < Conditions.Count; i++)
                {
                    var condition = Conditions[i];
                    var index = i;

                    <div style="position: relative;">
                        <FilterConditionRow Condition="@condition"
                                            AvailableProperties="@FilterableProperties"
                                            OnConditionChanged="@(() => OnConditionChanged())"
                                            OnRemoveRequested="@(() => RemoveCondition(condition))"
                                            CanRemove="@(Conditions.Count > 0)" />

                        @* UX IMPROVEMENT: Visual AND/OR separator between conditions *@
                        @if (i < Conditions.Count - 1)
                        {
                            <div class="d-flex align-center justify-center my-2">
                                <MudDivider Class="flex-grow-1" />
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Color="@(IsOrOperator ? Color.Secondary : Color.Primary)"
                                         Variant="Variant.Text"
                                         Class="mx-2"
                                         Style="font-weight: 600;">
                                    @(IsOrOperator ? L["FilterBuilder_LogicalOr"] : L["FilterBuilder_LogicalAnd"])
                                </MudChip>
                                <MudDivider Class="flex-grow-1" />
                            </div>
                        }
                    </div>
                }
            </MudStack>
        }
    </MudStack>
</MudPaper>

<style>
    .mud-input-monospace input,
    .mud-input-monospace textarea {
        font-family: 'Consolas', 'Monaco', 'Courier New', Courier, monospace;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .mud-button-group .mud-button {
        transition: all 0.2s ease-in-out;
    }

    .mud-chip {
        transition: all 0.2s ease-in-out;
    }

    .mud-paper {
        transition: box-shadow 0.2s ease-in-out;
    }
</style>

@code {
    /// <summary>
    /// List of properties that can be filtered
    /// </summary>
    [Parameter]
    public List<FilterableProperty> FilterableProperties { get; set; } = new();

    /// <summary>
    /// Initial conditions to load (optional)
    /// </summary>
    [Parameter]
    public List<FilterCondition> InitialConditions { get; set; } = new();

    /// <summary>
    /// Whether to show the generated Gridify query string
    /// </summary>
    [Parameter]
    public bool ShowGeneratedQuery { get; set; } = true;

    /// <summary>
    /// Event fired when the filter query changes
    /// </summary>
    [Parameter]
    public EventCallback<string> OnFilterChanged { get; set; }

    /// <summary>
    /// The current list of filter conditions
    /// </summary>
    public List<FilterCondition> Conditions { get; private set; } = new();

    /// <summary>
    /// The logical operator between conditions (false = AND, true = OR)
    /// </summary>
    private bool IsOrOperator { get; set; }

    /// <summary>
    /// The generated Gridify query string
    /// </summary>
    public string GeneratedQuery { get; private set; } = string.Empty;

    protected override void OnInitialized()
    {
        if (InitialConditions.Any())
        {
            Conditions = new List<FilterCondition>(InitialConditions);
        }
        else if (FilterableProperties.Any())
        {
            // Start with one empty condition
            AddCondition();
        }

        UpdateGeneratedQuery();
    }

    private void AddCondition()
    {
        var newCondition = new FilterCondition();

        // Pre-select the first property if available
        if (FilterableProperties.Any())
        {
            newCondition.Property = FilterableProperties.First();
            var operators = FilterOperatorExtensions.GetOperatorsForType(newCondition.Property.PropertyType);
            newCondition.Operator = operators.FirstOrDefault();

            // Set default value for boolean
            if (newCondition.Property.PropertyType == FilterPropertyType.Boolean)
            {
                newCondition.Value = "true";
            }
        }

        Conditions.Add(newCondition);
        UpdateGeneratedQuery();
    }

    private void RemoveCondition(FilterCondition condition)
    {
        Conditions.Remove(condition);
        UpdateGeneratedQuery();
    }

    private void ClearAll()
    {
        Conditions.Clear();
        UpdateGeneratedQuery();
    }

    private void OnConditionChanged()
    {
        UpdateGeneratedQuery();
    }

    private void OnLogicalOperatorChanged(bool isOr)
    {
        IsOrOperator = isOr;
        UpdateGeneratedQuery();
    }

    private void UpdateGeneratedQuery()
    {
        var validConditions = Conditions
            .Where(c => c.IsValid())
            .Select(c => c.ToGridifyString())
            .Where(s => !string.IsNullOrWhiteSpace(s))
            .ToList();

        if (!validConditions.Any())
        {
            GeneratedQuery = string.Empty;
        }
        else if (validConditions.Count == 1)
        {
            GeneratedQuery = validConditions[0];
        }
        else
        {
            var separator = IsOrOperator ? "|" : ",";
            GeneratedQuery = string.Join(separator, validConditions);
        }

        // Notify parent component
        OnFilterChanged.InvokeAsync(GeneratedQuery);
    }

    /// <summary>
    /// Gets the current Gridify filter query string
    /// </summary>
    public string GetFilterQuery() => GeneratedQuery;

    /// <summary>
    /// Programmatically set conditions
    /// </summary>
    public void SetConditions(List<FilterCondition> conditions)
    {
        Conditions = new List<FilterCondition>(conditions);
        UpdateGeneratedQuery();
        StateHasChanged();
    }

    /// <summary>
    /// Programmatically add a condition
    /// </summary>
    public void AddCondition(FilterCondition condition)
    {
        Conditions.Add(condition);
        UpdateGeneratedQuery();
        StateHasChanged();
    }
}
